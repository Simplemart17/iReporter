language: node_js
node_js:
- "stable"
install:
  - npm install
cache:
  directories:
    - "node_modules"
services:
  - postgresql

env:
  global:
    - CC_TEST_REPORTER_ID=d91e82f9734cc9e588b7dcad24ef53ac6f9d9a75333c2b5c1d54c2444035adb0
    
before_script:
  - yarn global add nyc
  - curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
  - chmod +x ./cc-test-reporter
  - ./cc-test-reporter before-build
  - psql -c 'create database travis_ci_test;' -U postgres
  - CREATE TABLE IF NOT EXISTS
  users(
    id SERIAL PRIMARY KEY,
    firstname VARCHAR(128) NOT NULL,
    lastname VARCHAR(128) NOT NULL,
    othername VARCHAR(128) NOT NULL,
    email VARCHAR(128) UNIQUE NOT NULL,
    phoneNumber BIGINT,
    username VARCHAR(128) UNIQUE NOT NULL,
    registered DATE DEFAULT CURRENT_DATE,
    password VARCHAR(128) NOT NULL,
    isAdmin BOOLEAN default FALSE
  );
  - CREATE TABLE IF NOT EXISTS
  records(
    id SERIAL PRIMARY KEY,
    createdOn DATE DEFAULT CURRENT_DATE,
    title VARCHAR(255) NOT NULL,
    createdBy INTEGER NOT NULL,
    type VARCHAR(128) NOT NULL,
    location VARCHAR(128) NOT NULL,
    status VARCHAR(128),
    images VARCHAR(128),
    videos VARCHAR(128),
    comment TEXT NOT NULL,
    FOREIGN KEY (createdBy) REFERENCES users (id) ON DELETE CASCADE
);

script:
  - nyc --reporter=lcov yarn run test

after_script:
  - ./cc-test-reporter after-build --exit-code $TRAVIS_TEST_RESULT
  - DROP TABLE users;
  - DROPT TABLE records;

notifications:
  email: false
